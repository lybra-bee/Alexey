<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéâ AI –û—Ç–∫—Ä—ã—Ç–∫–∞</title>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:Segoe UI,-apple-system,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;display:flex;align-items:center;justify-content:center}
        .app{background:#fff;border-radius:20px;padding:30px;max-width:500px;width:100%;box-shadow:0 20px 40px rgba(0,0,0,.2)}
        .step{display:none}
        .step.active{display:block;animation:slideIn .3s}
        @keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        h1{font-size:24px;margin-bottom:20px;text-align:center;color:#333}
        input,textarea{width:100%;padding:14px;margin:10px 0 20px;border:2px solid #e1e5e9;border-radius:12px;font-size:16px;box-sizing:border-box}
        input:focus,textarea:focus{outline:none;border-color:#667eea}
        button{width:100%;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:12px;font-size:16px;font-weight:500;cursor:pointer;transition:.2s;margin:5px 0}
        button:hover:not(:disabled){transform:translateY(-1px)}
        button:disabled{opacity:.6;cursor:not-allowed;transform:none}
        .result{padding:16px;background:#f8f9fa;border-radius:12px;border-left:4px solid #667eea;margin:15px 0;white-space:pre-wrap;display:none}
        .spinner{width:36px;height:36px;border:3px solid #f3f3f3;border-top:3px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin:20px auto;display:none}
        @keyframes spin{to{transform:rotate(360deg)}}
        .preview{max-width:100%;height:auto;border-radius:12px;margin:15px 0 10px;display:none;box-shadow:0 8px 25px rgba(0,0,0,.15)}
        canvas.preview{display:block;width:100%;height:auto;border-radius:12px;margin:15px 0 10px;box-shadow:0 8px 25px rgba(0,0,0,.15)}
        .back{background:#6c757d}
        .success{background:#28a745}
        .status{font-size:14px;color:#666;text-align:center;margin:10px 0}
    </style>
</head>
<body>
<div class="app">
    <!-- –®–∞–≥ 1: –¢–µ–∫—Å—Ç -->
    <div class="step active" id="s1">
        <h1>üìù –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ</h1>
        <input id="name" placeholder="–ö–æ–º—É (–ú–∞—à–∞)">
        <input id="occasion" placeholder="–ü–æ–≤–æ–¥ (–ù–æ–≤—ã–π –≥–æ–¥)">
        <div id="spin1" class="spinner"></div>
        <div id="textRes" class="result"></div>
        <button onclick="genText()">ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</button>
        <button class="success" onclick="toStep(2)" id="next1" style="display:none">‚úÖ –ö –∫–∞—Ä—Ç–∏–Ω–∫–µ</button>
    </div>

    <!-- –®–∞–≥ 2: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
    <div class="step" id="s2">
        <h1>üñºÔ∏è –û—Ç–∫—Ä—ã—Ç–∫–∞</h1>
        <textarea id="imgPrompt" rows="3" placeholder="–ß—Ç–æ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å? (–∫–æ—Ç —Å —à–∞—Ä–∏–∫–∞–º–∏, —Ü–≤–µ—Ç—ã, —Å–∞–ª—é—Ç...)"></textarea>
        <div id="status2" class="status"></div>
        <div id="spin2" class="spinner"></div>
        <img id="imgPrev" class="preview">
        <button onclick="genImg()">üé® –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
        <button class="success" onclick="renderCard()" id="next2" style="display:none">‚ú® –°–æ–±—Ä–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç–∫—É</button>
        <button class="back" onclick="toStep(1)">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <!-- –®–∞–≥ 3: –†–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div class="step" id="s3">
        <h1>üéÅ –ì–æ—Ç–æ–≤–æ!</h1>
        <canvas id="finalCard" class="preview"></canvas>
        <button onclick="download()">üì• –°–∫–∞—á–∞—Ç—å</button>
        <button class="back" onclick="toStep(2)">üîÑ –ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å</button>
    </div>
</div>

<script>
let textFinal="",imgFinal="";

function toStep(n){
    document.querySelectorAll(".step").forEach((s,i)=>s.id=="s"+n?s.classList.add("active"):s.classList.remove("active"))
}

async function genText(){
    const name=document.getElementById("name").value.trim(),occasion=document.getElementById("occasion").value.trim();
    if(!name||!occasion)return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");
    
    const btn=document.getElementById("next1"),spin=document.getElementById("spin1"),res=document.getElementById("textRes");
    btn.style.display="none";spin.style.display="block";res.style.display="none";
    
    try{
        const p=`–ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è ${name} —Å ${occasion}. 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –¥—É—à–µ–≤–Ω–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º.`;
        const r=await fetch(`https://text.pollinations.ai/${encodeURIComponent(p)}`);
        textFinal=(await r.text()).trim();
        res.textContent=textFinal;
        res.style.display="block";
        btn.style.display="block"
    }catch(e){
        alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.")
    }finally{
        spin.style.display="none"
    }
}

async function genImg(){
    const prompt=document.getElementById("imgPrompt").value.trim()||"–ø—Ä–∞–∑–¥–Ω–∏—á–Ω–∞—è –æ—Ç–∫—Ä—ã—Ç–∫–∞";
    const btn=document.getElementById("next2"),spin=document.getElementById("spin2"),status=document.getElementById("status2"),img=document.getElementById("imgPrev");
    
    btn.style.display="none";spin.style.display="block";status.textContent="–ì–µ–Ω–µ—Ä–∏—Ä—É—é...";img.style.display="none";
    
    const seed=Math.floor(Math.random()*1e6);
    // Pollinations Image API [web:75]
    imgFinal=`https://image.pollinations.ai/prompt/${encodeURIComponent(prompt+", greeting card style, high quality, no text")}?width=512&height=768&seed=${seed}&nologo=true`;
    
    img.onload=()=>{
        spin.style.display="none";
        status.textContent="–ì–æ—Ç–æ–≤–æ!";
        img.style.display="block";
        btn.style.display="block";
    };
    img.onerror=()=>{
        spin.style.display="none";
        status.textContent="–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.";
    };
    img.src=imgFinal;
}

function renderCard(){
    toStep(3);
    const canvas=document.getElementById("finalCard"),ctx=canvas.getContext("2d"),img=new Image();
    img.crossOrigin="anonymous";
    
    img.onload=()=>{
        canvas.width=512;canvas.height=768;canvas.style.display="block";
        
        // –§–æ–Ω
        ctx.drawImage(img,0,0,512,768);
        
        // –ü–æ–¥–ª–æ–∂–∫–∞
        ctx.fillStyle="rgba(0,0,0,0.7)";
        ctx.fillRect(35,530,442,190);
        
        // –†–∞–º–∫–∞
        ctx.strokeStyle="#ffd700";ctx.lineWidth=10;
        ctx.strokeRect(20,20,472,728);
        
        // –¢–µ–∫—Å—Ç
        ctx.fillStyle="#fff";
        ctx.font="bold 24px Segoe UI,Arial";
        ctx.textAlign="center";
        let words=textFinal.split(" "),line="",y=575;
        for(let i=0;i<words.length;i++){
            let test=line+words[i]+" ";
            if(ctx.measureText(test).width>400&&i>0){
                ctx.fillText(line.trim(),256,y);
                line=words[i]+" ";y+=32
            }else line=test
        }
        ctx.fillText(line.trim(),256,y)
    };
    img.src=imgFinal
}

function download(){
    const canvas=document.getElementById("finalCard"),a=document.createElement("a");
    a.download="ai-otkrytka.png";
    a.href=canvas.toDataURL("image/png");
    a.click()
}
</script>
</body>
</html>
