<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéâ AI –ü–æ–∑–¥—Ä–∞–≤–∏—Ç–µ–ª—å–Ω–∞—è –û—Ç–∫—Ä—ã—Ç–∫–∞</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .app { background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); max-width: 600px; width: 100%; overflow: hidden; }
        .step { padding: 40px; display: none; text-align: center; }
        .step.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        h1 { color: #333; margin-bottom: 30px; font-size: 28px; }
        input, textarea { width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 16px; margin-bottom: 20px; transition: border-color 0.3s; }
        input:focus, textarea:focus { outline: none; border-color: #667eea; }
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 30px; border-radius: 12px; font-size: 16px; cursor: pointer; transition: transform 0.2s; margin: 10px; }
        button:hover:not(:disabled) { transform: translateY(-2px); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .preview { max-width: 100%; max-height: 400px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin: 20px 0; }
        .text-preview { background: #f8f9fa; padding: 20px; border-radius: 12px; font-size: 18px; line-height: 1.6; text-align: left; min-height: 100px; white-space: pre-wrap; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress { margin: 20px 0; font-size: 14px; color: #666; }
        .back-btn { background: #6c757d; }
        .download-btn { background: #28a745; font-size: 18px; padding: 20px 40px; }
        footer { text-align: center; padding: 20px; color: #666; font-size: 14px; }
        .ai-badge { background: #10b981; color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; margin-left: 10px; }
    </style>
</head>
<body>
    <div class="app">
        <!-- –®–∞–≥ 1: –ò–º—è –∏ –ø–æ–≤–æ–¥ -->
        <div class="step active" id="step1">
            <h1>üéâ –°–æ–∑–¥–∞–π –ø–æ–∑–¥—Ä–∞–≤–∏—Ç–µ–ª—å–Ω—É—é –æ—Ç–∫—Ä—ã—Ç–∫—É</h1>
            <p><small>–†–µ–∞–ª—å–Ω—ã–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏: <span class="ai-badge">DeepSeek</span> + <span class="ai-badge">Stable Diffusion</span></small></p>
            <input type="text" id="name" placeholder="–ò–º—è (–ú–∞—à–∞, –ü–∞–ø–∞...)" required>
            <input type="text" id="occasion" placeholder="–ü–æ–≤–æ–¥ (–ù–æ–≤—ã–π –≥–æ–¥, –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è...)" required>
            <button onclick="generateText()">ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</button>
            <div id="textSpinner" class="spinner" style="display:none;"></div>
            <div id="generatedText" class="text-preview" style="display:none;"></div>
            <button id="approveText" onclick="nextStep(2)" style="display:none;">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
        </div>

        <!-- –®–∞–≥ 2: –ö–∞—Ä—Ç–∏–Ω–∫–∞ -->
        <div class="step" id="step2">
            <h1>üñºÔ∏è –û–ø–∏—à–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É</h1>
            <textarea id="imagePrompt" rows="3" placeholder="–º–∏–ª—ã–π –∫–æ—Ç—ë–Ω–æ–∫ —Å —à–∞—Ä–∏–∫–∞–º–∏, –∑–∏–º–Ω–∏–π –ª–µ—Å, —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ —Ü–≤–µ—Ç—ã..."></textarea>
            <div class="progress" id="progress"></div>
            <button onclick="generateImage()">üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å (Stable Diffusion)</button>
            <div id="imageSpinner" class="spinner" style="display:none;"></div>
            <img id="generatedImage" class="preview" style="display:none;" crossorigin="anonymous">
            <button id="approveImage" onclick="renderCard()" style="display:none;">‚ú® –°–æ–∑–¥–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç–∫—É</button>
            <button class="back-btn" onclick="prevStep(1)">‚Üê –ù–∞–∑–∞–¥</button>
        </div>

        <!-- –®–∞–≥ 3: –ì–æ—Ç–æ–≤–∞—è –æ—Ç–∫—Ä—ã—Ç–∫–∞ -->
        <div class="step" id="step3">
            <h1>üéÅ –¢–≤–æ—è –æ—Ç–∫—Ä—ã—Ç–∫–∞ –≥–æ—Ç–æ–≤–∞!</h1>
            <canvas id="finalCard" class="preview"></canvas>
            <button class="download-btn" onclick="downloadCard()">üì• –°–∫–∞—á–∞—Ç—å PNG</button>
            <button onclick="resetApp()">üîÑ –ù–æ–≤–∞—è –æ—Ç–∫—Ä—ã—Ç–∫–∞</button>
        </div>

        <footer>üöÄ –†–µ–∞–ª—å–Ω—ã–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –±–µ–∑ –∫–ª—é—á–µ–π: MLvoca DeepSeek + AI Horde Stable Diffusion</footer>
    </div>

    <script>
        let currentStep = 1;
        let greetingText = '';
        let generatedImageUrl = '';
        let pollInterval;

        // ‚úÖ –†–ï–ê–õ–¨–ù–ê–Ø –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞: MLvoca DeepSeek API (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ –∫–ª—é—á–µ–π)
        async function generateText() {
            const name = document.getElementById('name').value.trim();
            const occasion = document.getElementById('occasion').value.trim();
            if (!name || !occasion) return alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!');

            document.getElementById('textSpinner').style.display = 'block';
            document.getElementById('generatedText').style.display = 'none';
            document.getElementById('approveText').style.display = 'none';

            const prompt = `–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ, –¥—É—à–µ–≤–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è ${name} –ø–æ –ø–æ–≤–æ–¥—É ${occasion}. 
            3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º. –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ–∑–∏—Ç–∏–≤–Ω–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. 
            –ë–µ–∑ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π —Ç–∏–ø–∞ "–£–≤–∞–∂–∞–µ–º—ã–π".`;

            try {
                const response = await fetch('https://api.mlvoca.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'deepseek-r1:free',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 200,
                        temperature: 0.8
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                greetingText = data.choices[0].message.content.trim();
            } catch (error) {
                console.error('MLvoca error:', error);
                // Fallback –∫ –¥—Ä—É–≥–æ–π –º–æ–¥–µ–ª–∏ –µ—Å–ª–∏ MLvoca –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
                greetingText = await fallbackTextGen(name, occasion);
            }

            document.getElementById('generatedText').textContent = greetingText;
            document.getElementById('generatedText').style.display = 'block';
            document.getElementById('approveText').style.display = 'inline-block';
            document.getElementById('textSpinner').style.display = 'none';
        }

        // Fallback: Hugging Face ruGPT
        async function fallbackTextGen(name, occasion) {
            const prompt = `${name}, ${occasion}. –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ: `;
            try {
                const response = await fetch('https://api-inference.huggingface.co/models/IlyaGusev/rugpt3_small_based_on_gpt2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ inputs: prompt, parameters: { max_new_tokens: 80, temperature: 0.7 } })
                });
                const data = await response.json();
                return data[0]?.generated_text.slice(prompt.length).trim() || `–ü–æ–∑–¥—Ä–∞–≤–ª—è—é ${name} —Å ${occasion}! üéâ`;
            } catch {
                return `–î–æ—Ä–æ–≥–æ–π ${name}! –° ${occasion}! –ñ–µ–ª–∞—é —Å—á–∞—Å—Ç—å—è –∏ —Ä–∞–¥–æ—Å—Ç–∏! ‚ù§Ô∏è`;
            }
        }

        // ‚úÖ –†–ï–ê–õ–¨–ù–ê–Ø –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏: AI Horde Stable Diffusion
        async function generateImage() {
            const prompt = (document.getElementById('imagePrompt').value.trim() || '–ø—Ä–∞–∑–¥–Ω–∏—á–Ω–∞—è –æ—Ç–∫—Ä—ã—Ç–∫–∞').replace(/–±–µ–∑ —Ç–µ–∫—Å—Ç–∞|no text/gi, '');
            document.getElementById('imageSpinner').style.display = 'block';
            document.getElementById('progress').textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –æ—á–µ—Ä–µ–¥—å Stable Diffusion...';
            document.getElementById('approveImage').style.display = 'none';

            try {
                const response = await fetch('https://aihorde.net/api/v2/generate/async', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: `${prompt}, –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ, –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ, –ø—Ä–∞–∑–¥–Ω–∏—á–Ω–æ, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏, 512x768`,
                        params: {
                            sampler_name: 'k_euler_a',
                            width: 512,
                            height: 768,
                            steps: 28,
                            cfg_scale: 7.5,
                            seed: -1,
                            k: 1
                        },
                        models: ['DreamShaper_v8', 'Deliberate_v2', 'Realistic_Vision_V5.1'],
                        apikey: '0000000000' // –ê–Ω–æ–Ω–∏–º–Ω—ã–π –¥–æ—Å—Ç—É–ø
                    })
                });

                const data = await response.json();
                if (!data.id) throw new Error('–ù–µ—Ç ID –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');

                pollImageStatus(data.id);
            } catch (error) {
                document.getElementById('imageSpinner').style.display = 'none';
                document.getElementById('progress').textContent = '–û—à–∏–±–∫–∞: ' + error.message;
            }
        }

        // –ü–æ–ª–ª–∏–Ω–≥ AI Horde
        async function pollImageStatus(jobId) {
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`https://aihorde.net/api/v2/generate/status/${jobId}`);
                    const data = await response.json();
                    
                    const done = data.generations?.length || 0;
                    const total = data.n || 1;
                    document.getElementById('progress').textContent = 
                        data.queue_position ? `‚è≥ ${data.queue_position} –≤ –æ—á–µ—Ä–µ–¥–∏` : 
                        `‚úÖ –ì–æ—Ç–æ–≤–æ: ${done}/${total}`;

                    if (done > 0) {
                        clearInterval(pollInterval);
                        generatedImageUrl = data.generations[0].img;
                        document.getElementById('generatedImage').src = generatedImageUrl;
                        document.getElementById('generatedImage').style.display = 'block';
                        document.getElementById('approveImage').style.display = 'inline-block';
                        document.getElementById('imageSpinner').style.display = 'none';
                        document.getElementById('progress').textContent = '–ì–æ—Ç–æ–≤–æ! ‚ú®';
                    }
                } catch (e) {
                    clearInterval(pollInterval);
                    document.getElementById('imageSpinner').style.display = 'none';
                }
            }, 4000);
        }

        // –†–µ–Ω–¥–µ—Ä —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –æ—Ç–∫—Ä—ã—Ç–∫–∏
        function renderCard() {
            nextStep(3);
            const canvas = document.getElementById('finalCard');
            const ctx = canvas.getContext('2d');
            canvas.width = 512;
            canvas.height = 768;

            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
                ctx.drawImage(img, 0, 0, 512, 768);

                // –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –¥–ª—è —Ç–µ–∫—Å—Ç–∞
                const gradient = ctx.createLinearGradient(0, 550, 0, 750);
                gradient.addColorStop(0, 'rgba(0,0,0,0.8)');
                gradient.addColorStop(1, 'rgba(0,0,0,0.4)');
                ctx.fillStyle = gradient;
                ctx.fillRect(40, 520, 432, 228);

                // –ö—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 36px "Segoe UI", sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(greetingText, 256, 580, 440);

                // –ó–æ–ª–æ—Ç–∞—è —Ä–∞–º–∫–∞
                ctx.strokeStyle = '#ffd700';
                ctx.lineWidth = 12;
                ctx.lineCap = 'round';
                ctx.strokeRect(24, 24, 464, 720);
            };
            img.onerror = () => alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            img.src = generatedImageUrl;
        }

        function downloadCard() {
            const canvas = document.getElementById('finalCard');
            const link = document.createElement('a');
            link.download = `otkrytka_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function nextStep(step) {
            document.querySelectorAll('.step').forEach((s, i) => s.classList.toggle('active', i + 1 === step));
            currentStep = step;
        }
        function prevStep(step) { nextStep(step); }
        function resetApp() { location.reload(); }

        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && e.key === 'Enter') {
                if (currentStep === 1) generateText();
                if (currentStep === 2) generateImage();
            }
        });
    </script>
</body>
</html>
