import requests
import json
import os
from datetime import datetime

API_KEY = os.getenv("OPENAI_API_KEY", "hf_xxx")  # сюда подставит GitHub секрет
API_URL = "https://api.openai.com/v1/chat/completions"

def generate_news():
    prompt = """
    Сгенерируй 5 свежих новостей об ИИ, технологиях и науке.
    Формат JSON: [{"title": "...", "content": "...", "imageUrl": "..."}]
    Картинки бери с https://picsum.photos/800/400?random=...
    """
    headers = {"Authorization": f"Bearer {API_KEY}", "Content-Type": "application/json"}
    data = {
        "model": "gpt-4o-mini",
        "messages": [{"role": "user", "content": prompt}],
        "temperature": 0.8
    }

    r = requests.post(API_URL, headers=headers, json=data)
    r.raise_for_status()

    text = r.json()["choices"][0]["message"]["content"]
    try:
        news = json.loads(text)
    except:
        news = [{"title": "Ошибка генерации", "content": text, "imageUrl": ""}]

    return news

if __name__ == "__main__":
    news = generate_news()
    with open("news.json", "w", encoding="utf-8") as f:
        json.dump(news, f, ensure_ascii=False, indent=2)
    print(f"[{datetime.now()}] Обновлено {len(news)} новостей")
